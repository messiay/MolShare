<!DOCTYPE html>
<html>

<head>
    <title>MolShare 3Dmol.js Benchmark</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <style>
        body {
            font-family: monospace;
            background: #111;
            color: #0f0;
            padding: 20px;
        }

        #viewer {
            width: 800px;
            height: 600px;
            border: 1px solid #333;
            margin: 10px 0;
        }

        #log {
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        button {
            padding: 8px 16px;
            margin: 4px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>MolShare Rendering Benchmark</h2>
    <p>Tests the exact same 3Dmol.js/WebGL pipeline used by MolShare.</p>
    <div id="viewer"></div>
    <div>
        <button onclick="runBenchmark('4HHB', '~4,400')">Test ~4.4K atoms (4HHB Hemoglobin)</button>
        <button onclick="runBenchmark('1JFF', '~25,000')">Test ~25K atoms (1JFF Glutamate DH)</button>
        <button onclick="runBenchmark('1AON', '~58,000')">Test ~58K atoms (1AON GroEL)</button>
        <button onclick="runBenchmark('4V6X', '~100,000+')">Test ~100K+ atoms (4V6X Ribosome)</button>
        <button onclick="measureFPS()">Measure FPS (current model)</button>
    </div>
    <h3>Results:</h3>
    <div id="log"></div>

    <script>
        const logEl = document.getElementById('log');
        let currentViewer = null;

        function log(msg) {
            logEl.textContent += msg + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        // Detect hardware
        function getGPUInfo() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) return 'WebGL not available';
            const ext = gl.getExtension('WEBGL_debug_renderer_info');
            if (ext) {
                return gl.getParameter(ext.UNMASKED_RENDERER_WEBGL);
            }
            return 'Unknown GPU';
        }

        log('=== HARDWARE INFO ===');
        log('User Agent: ' + navigator.userAgent);
        log('GPU: ' + getGPUInfo());
        log('Cores: ' + navigator.hardwareConcurrency);
        log('Memory: ' + (navigator.deviceMemory || 'N/A') + ' GB');
        log('Screen: ' + screen.width + 'x' + screen.height);
        log('========================\n');

        async function runBenchmark(pdbId, label) {
            log(`\n--- Benchmark: ${pdbId} (${label} atoms) ---`);
            const container = document.getElementById('viewer');
            container.innerHTML = '';

            const t0 = performance.now();
            log(`[${(performance.now() - t0).toFixed(0)}ms] Fetching PDB from RCSB...`);

            try {
                const resp = await fetch(`https://files.rcsb.org/download/${pdbId}.pdb`);
                if (!resp.ok) throw new Error('Fetch failed: ' + resp.status);
                const data = await resp.text();
                const tFetch = performance.now();
                const fetchTime = (tFetch - t0).toFixed(0);

                // Count atoms
                const atomCount = (data.match(/^ATOM  /gm) || []).length + (data.match(/^HETATM/gm) || []).length;
                log(`[${fetchTime}ms] Fetched. File size: ${(data.length / 1024).toFixed(0)} KB, Atoms: ${atomCount}`);

                // Create viewer
                const tViewerStart = performance.now();
                currentViewer = $3Dmol.createViewer(container, { backgroundColor: 'white' });
                currentViewer.addModel(data, 'pdb');

                // Apply same styles as MolShare MoleculeViewer
                currentViewer.setStyle({}, { cartoon: { color: 'spectrum' }, stick: {} });
                currentViewer.zoomTo();
                currentViewer.render();
                const tRender = performance.now();

                const renderTime = (tRender - tViewerStart).toFixed(0);
                const totalTime = (tRender - t0).toFixed(0);

                log(`[${totalTime}ms] Render complete.`);
                log(`  Fetch time:  ${fetchTime} ms`);
                log(`  Render time: ${renderTime} ms`);
                log(`  TOTAL (load-to-render): ${totalTime} ms = ${(totalTime / 1000).toFixed(2)} s`);
                log(`  Atom count: ${atomCount}`);

                // Also measure second render (warm)
                const t2 = performance.now();
                currentViewer.render();
                const t3 = performance.now();
                log(`  Re-render (warm): ${(t3 - t2).toFixed(1)} ms`);

            } catch (e) {
                log('ERROR: ' + e.message);
            }
        }

        function measureFPS() {
            if (!currentViewer) { log('No model loaded. Run a benchmark first.'); return; }
            log('\n--- FPS Measurement (5 seconds, continuous rotation) ---');
            let frameCount = 0;
            const startTime = performance.now();
            let angle = 0;

            function frame() {
                angle += 2;
                currentViewer.rotate(2, 'y');
                currentViewer.render();
                frameCount++;
                if (performance.now() - startTime < 5000) {
                    requestAnimationFrame(frame);
                } else {
                    const elapsed = (performance.now() - startTime) / 1000;
                    const fps = (frameCount / elapsed).toFixed(1);
                    log(`  Frames: ${frameCount} in ${elapsed.toFixed(2)}s`);
                    log(`  Average FPS: ${fps}`);
                    log('--- FPS Measurement Complete ---');
                }
            }
            requestAnimationFrame(frame);
        }
    </script>
</body>

</html>